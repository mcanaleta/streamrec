#
name: Tag new version

# Configures this workflow to run every time a change is pushed to the branch called `release`.
on:
  workflow_run:
    workflows: ["Create docker image"]
    branches: [release]
    types: 
      - completed

# Defines two custom environment variables for the workflow. These are used for the Container registry domain, and a name for the Docker image that this workflow builds.
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# There is a single job in this workflow. It's configured to run on the latest available version of Ubuntu.
jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    # Sets the permissions granted to the `GITHUB_TOKEN` for the actions in this job.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_tag
        run: echo "TAG=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV

      - name: Increment version
        run: |
          latest_tag="${TAG:-0.0.0}"
          IFS='.' read -ra VERSION <<< "$latest_tag"
          major=${VERSION[0]}
          minor=${VERSION[1]}
          patch=${VERSION[2]}
          new_tag="$major.$minor.$((patch + 1))"
          echo "NEW_TAG=$new_tag" >> $GITHUB_ENV

      - name: Create and push tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag $NEW_TAG
          git push origin $NEW_TAG
